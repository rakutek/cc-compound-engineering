---
name: workflows:plan
description: 機能説明を規約に従った構造化されたプロジェクトプランに変換する
argument-hint: "[機能説明、バグレポート、または改善アイデア]"
---

# 新機能またはバグ修正のプランを作成

## はじめに

**注意: 現在の年は2026年です。** プランの日付付けや最新のドキュメント検索の際にこれを使用してください。

機能説明、バグレポート、または改善アイデアを、プロジェクトの規約とベストプラクティスに従った構造化されたマークダウンファイルイシューに変換します。このコマンドはニーズに合わせた柔軟な詳細レベルを提供します。

## 機能説明

<feature_description> #$ARGUMENTS </feature_description>

**上記の機能説明が空の場合、ユーザーに質問：** 「何を計画しますか？お考えの機能、バグ修正、または改善を説明してください。」

ユーザーから明確な機能説明が得られるまで進めないでください。

## 主要タスク

### 1. リポジトリリサーチ & コンテキスト収集

<thinking>
まず、並列サブエージェントを活用して、プロジェクトの規約と既存のパターンを理解する必要があります。
</thinking>

これら3つのエージェントを同時に並列で実行：

- Task repo-research-analyst(feature_description)
- Task best-practices-researcher(feature_description)
- Task framework-docs-researcher(feature_description)

**リファレンス収集：**

- [ ] 具体的なファイルパス（例：`app/services/example_service.rb:42`）ですべてのリサーチ結果を文書化
- [ ] 外部ドキュメントとベストプラクティスガイドへのURLを含める
- [ ] 類似のイシューやPRのリファレンスリストを作成（例：`#123`、`#456`）
- [ ] `CLAUDE.md`やチームドキュメントで発見したチーム規約をメモ

### 2. イシュー計画 & 構造

<thinking>
プロダクトマネージャーのように考える - このイシューを明確で実行可能にするには？複数の視点を考慮
</thinking>

**タイトル & カテゴリ分け：**

- [ ] 従来のフォーマットを使用して明確で検索可能なイシュータイトルを作成（例：`feat:`、`fix:`、`docs:`）
- [ ] イシュータイプを決定：enhancement、bug、refactor

**ステークホルダー分析：**

- [ ] このイシューの影響を受ける人を特定（エンドユーザー、開発者、運用）
- [ ] 実装の複雑さと必要な専門知識を考慮

**コンテンツ計画：**

- [ ] イシューの複雑さと対象者に基づいて適切な詳細レベルを選択
- [ ] 選択したテンプレートに必要なすべてのセクションをリスト
- [ ] サポート資料を収集（エラーログ、スクリーンショット、デザインモックアップ）
- [ ] コード例や再現手順を準備（該当する場合）、リスト内のモックファイル名を指定

### 3. SpecFlow分析

イシュー構造を計画した後、SpecFlow Analyzerを実行して機能仕様を検証・改善：

- Task spec-flow-analyzer(feature_description, research_findings)

**SpecFlow Analyzer出力：**

- [ ] SpecFlow分析結果をレビュー
- [ ] 特定されたギャップやエッジケースをイシューに組み込む
- [ ] SpecFlowの発見に基づいて受け入れ基準を更新

### 4. 実装詳細レベルの選択

イシューをどの程度包括的にするか選択します。シンプルな方がほとんどの場合良いです。

#### 📄 MINIMAL（クイックイシュー）

**最適な用途：** 単純なバグ、小さな改善、明確な機能

**含まれるもの：**

- 問題文または機能説明
- 基本的な受け入れ基準
- 必要最小限のコンテキストのみ

**構造：**

````markdown
[簡潔な問題/機能説明]

## 受け入れ基準

- [ ] コア要件1
- [ ] コア要件2

## コンテキスト

[重要な情報のみ]

## MVP

### test.rb

```ruby
class Test
  def initialize
    @name = "test"
  end
end
```

## 参照

- 関連イシュー：#[issue_number]
- ドキュメント：[relevant_docs_url]
````

#### 📋 MORE（標準イシュー）

**最適な用途：** ほとんどの機能、複雑なバグ、チームコラボレーション

**MINIMALに加えて含まれるもの：**

- 詳細な背景と動機
- 技術的考慮事項
- 成功メトリクス
- 依存関係とリスク
- 基本的な実装提案

**構造：**

```markdown
## 概要

[包括的な説明]

## 問題文 / 動機

[なぜこれが重要か]

## 提案されるソリューション

[ハイレベルなアプローチ]

## 技術的考慮事項

- アーキテクチャへの影響
- パフォーマンスへの影響
- セキュリティの考慮事項

## 受け入れ基準

- [ ] 詳細な要件1
- [ ] 詳細な要件2
- [ ] テスト要件

## 成功メトリクス

[成功をどう測定するか]

## 依存関係 & リスク

[これをブロックまたは複雑にする可能性があるもの]

## 参照 & リサーチ

- 類似実装：[file_path:line_number]
- ベストプラクティス：[documentation_url]
- 関連PR：#[pr_number]
```

#### 📚 A LOT（包括的イシュー）

**最適な用途：** 主要な機能、アーキテクチャ変更、複雑な統合

**MOREに加えて含まれるもの：**

- フェーズ付きの詳細な実装計画
- 検討された代替アプローチ
- 広範な技術仕様
- リソース要件とタイムライン
- 将来の考慮事項と拡張性
- リスク軽減戦略
- ドキュメント要件

**構造：**

```markdown
## 概要

[エグゼクティブサマリー]

## 問題文

[詳細な問題分析]

## 提案されるソリューション

[包括的なソリューション設計]

## 技術的アプローチ

### アーキテクチャ

[詳細な技術設計]

### 実装フェーズ

#### フェーズ1：[基盤]

- タスクと成果物
- 成功基準
- 推定工数

#### フェーズ2：[コア実装]

- タスクと成果物
- 成功基準
- 推定工数

#### フェーズ3：[仕上げ & 最適化]

- タスクと成果物
- 成功基準
- 推定工数

## 検討した代替アプローチ

[評価した他のソリューションと却下理由]

## 受け入れ基準

### 機能要件

- [ ] 詳細な機能基準

### 非機能要件

- [ ] パフォーマンス目標
- [ ] セキュリティ要件
- [ ] アクセシビリティ基準

### 品質ゲート

- [ ] テストカバレッジ要件
- [ ] ドキュメントの完全性
- [ ] コードレビュー承認

## 成功メトリクス

[詳細なKPIと測定方法]

## 依存関係 & 前提条件

[詳細な依存関係分析]

## リスク分析 & 軽減策

[包括的なリスク評価]

## リソース要件

[チーム、時間、インフラニーズ]

## 将来の考慮事項

[拡張性と長期ビジョン]

## ドキュメント計画

[更新が必要なドキュメント]

## 参照 & リサーチ

### 内部参照

- アーキテクチャ決定：[file_path:line_number]
- 類似機能：[file_path:line_number]
- 設定：[file_path:line_number]

### 外部参照

- フレームワークドキュメント：[url]
- ベストプラクティスガイド：[url]
- 業界標準：[url]

### 関連作業

- 過去のPR：#[pr_numbers]
- 関連イシュー：#[issue_numbers]
- 設計ドキュメント：[links]
```

### 5. イシュー作成 & フォーマット

<thinking>
明確さと実行可能性のベストプラクティスを適用し、イシューをスキャンしやすく理解しやすくする
</thinking>

**コンテンツフォーマット：**

- [ ] 適切な階層を持つ明確で説明的な見出しを使用（##、###）
- [ ] 言語シンタックスハイライト付きのトリプルバッククォートでコード例を含める
- [ ] UI関連の場合はスクリーンショット/モックアップを追加（ドラッグ&ドロップまたは画像ホスティング使用）
- [ ] チェックオフ可能な追跡項目にはタスクリスト（- [ ]）を使用
- [ ] 長いログやオプション詳細には`<details>`タグで折りたたみセクションを追加
- [ ] 視覚的スキャン用に適切な絵文字を適用（🐛 bug、✨ feature、📚 docs、♻️ refactor）

**相互参照：**

- [ ] #number形式を使用して関連イシュー/PRにリンク
- [ ] 関連する場合はSHAハッシュで特定のコミットを参照
- [ ] GitHubのパーマリンク機能を使用してコードにリンク（永久リンクには'y'を押す）
- [ ] 必要に応じて@usernameで関連チームメンバーにメンション
- [ ] 説明的なテキストで外部リソースへのリンクを追加

**コード & 例：**

````markdown
# シンタックスハイライトと行参照付きの良い例


```ruby
# app/services/user_service.rb:42
def process_user(user)

# ここに実装

end
```

# 折りたたみエラーログ

<details>
<summary>完全なエラースタックトレース</summary>

`エラー詳細をここに...`

</details>
````

**AI時代の考慮事項：**

- [ ] AIペアプログラミングによる加速された開発を考慮
- [ ] リサーチ中にうまくいったプロンプトや指示を含める
- [ ] 初期探索に使用したAIツールをメモ（Claude、Copilotなど）
- [ ] 迅速な実装を考慮した包括的テストを強調
- [ ] 人間のレビューが必要なAI生成コードを文書化

### 6. 最終レビュー & 提出

**提出前チェックリスト：**

- [ ] タイトルが検索可能で説明的
- [ ] ラベルがイシューを正確にカテゴリ分け
- [ ] すべてのテンプレートセクションが完了
- [ ] リンクと参照が機能
- [ ] 受け入れ基準が測定可能
- [ ] 疑似コード例とToDoリストにファイル名を追加
- [ ] 新しいモデル変更の場合は該当すればERD mermaidダイアグラムを追加

## 出力フォーマット

プランを`plans/<issue_title>.md`に書き込む

## 生成後のオプション

プランファイルを書き込んだ後、**AskUserQuestion tool**を使用してこれらのオプションを提示：

**質問：** "`plans/<issue_title>.md`にプランが準備できました。次に何をしますか？"

**オプション：**
1. **エディタでプランを開く** - レビュー用にプランファイルを開く
2. **`/deepen-plan`を実行** - 並列リサーチエージェントで各セクションを強化（ベストプラクティス、パフォーマンス、UI）
3. **`/plan-review`を実行** - レビュアーからフィードバックを取得（DHH、Kieran、Simplicity）
4. **`/workflows:work`を開始** - このプランのローカル実装を開始
5. **リモートで`/workflows:work`を開始** - Web上のClaude Codeで実装開始（バックグラウンド実行に`&`を使用）
6. **イシューを作成** - プロジェクトトラッカー（GitHub/Linear）にイシューを作成
7. **簡略化** - 詳細レベルを下げる

選択に基づいて：
- **エディタでプランを開く** → `open plans/<issue_title>.md`を実行してユーザーのデフォルトエディタでファイルを開く
- **`/deepen-plan`** → プランファイルパスで/deepen-planコマンドを呼び出してリサーチで強化
- **`/plan-review`** → プランファイルパスで/plan-reviewコマンドを呼び出す
- **`/workflows:work`** → プランファイルパスで/workflows:workコマンドを呼び出す
- **リモートで`/workflows:work`** → `/workflows:work plans/<issue_title>.md &`を実行してClaude Code webでバックグラウンド作業を開始
- **イシューを作成** → 以下の「イシュー作成」セクションを参照
- **簡略化** → 「何を簡略化しますか？」と質問し、よりシンプルなバージョンを再生成
- **その他**（自動提供） → 再作業や特定の変更のためのフリーテキストを受け付け

**注意：** ultrathinkが有効な状態で`/workflows:plan`を実行する場合、最大の深さと根拠のためにプラン作成後に自動的に`/deepen-plan`を実行。

ユーザーが`/workflows:work`または`/plan-review`を選択するまで、簡略化またはその他の変更後にオプションに戻る。

## イシュー作成

ユーザーが「イシューを作成」を選択した場合、CLAUDE.mdからプロジェクトトラッカーを検出：

1. **ユーザーのCLAUDE.md（グローバルまたはプロジェクト）でトラッカー設定をチェック：**
   - `project_tracker: github` または `project_tracker: linear` を探す
   - またはワークフローセクションで「GitHub Issues」や「Linear」の言及を探す

2. **GitHubの場合：**
   ```bash
   # プランファイル名からタイトルを抽出（kebab-caseをTitle Caseに）
   # bodyにはプランコンテンツを読み込む
   gh issue create --title "feat: [Plan Title]" --body-file plans/<issue_title>.md
   ```

3. **Linearの場合：**
   ```bash
   # 利用可能な場合はlinear CLIを使用、または手順を提供
   # linear issue create --title "[Plan Title]" --description "$(cat plans/<issue_title>.md)"
   ```

4. **トラッカーが設定されていない場合：**
   ユーザーに質問：「どのプロジェクトトラッカーを使用していますか？（GitHub/Linear/Other）」
   - CLAUDE.mdに`project_tracker: github`または`project_tracker: linear`を追加することを提案

5. **作成後：**
   - イシューURLを表示
   - `/workflows:work`または`/plan-review`に進むか質問

コードは書かないでください！リサーチとプランの作成のみ。
