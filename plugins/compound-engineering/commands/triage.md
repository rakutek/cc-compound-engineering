---
name: triage
description: CLI Todoシステムのために発見事項をトリアージして分類する
argument-hint: "[発見事項リストまたはソースタイプ]"
---

- まず/modelをHaikuに設定
- 次にtodos/ディレクトリ内のすべての保留中のTodoを読む

すべての発見事項、決定、またはイシューをトリアージのために一つずつ提示します。目標は各アイテムを確認し、CLI Todoシステムに追加するかどうかを決定することです。

**重要: トリアージ中にコードを書かないでください！**

このコマンドの用途：

- コードレビューの発見事項のトリアージ
- セキュリティ監査結果の処理
- パフォーマンス分析のレビュー
- 追跡が必要なその他の分類された発見事項の処理

## ワークフロー

### ステップ1: 各発見事項を提示

各発見事項について、このフォーマットで提示：

```
---
イシュー #X: [簡潔なタイトル]

重大度: 🔴 P1 (クリティカル) / 🟡 P2 (重要) / 🔵 P3 (あれば良い)

カテゴリ: [セキュリティ/パフォーマンス/アーキテクチャ/バグ/機能/など]

説明:
[イシューまたは改善の詳細な説明]

場所: [file_path:line_number]

問題シナリオ:
[何が問題か、または何が起こりうるかのステップバイステップ]

提案されるソリューション:
[修正方法]

推定工数: [小規模 (< 2時間) / 中規模 (2-8時間) / 大規模 (> 8時間)]

---
これをTodoリストに追加しますか？
1. yes - Todoファイルを作成
2. next - このアイテムをスキップ
3. custom - 作成前に修正
```

### ステップ2: ユーザーの決定を処理

**ユーザーが「yes」と言った場合：**

1. **既存のTodoファイルを更新**（存在する場合）または**新しいファイル名を作成：**

   Todoが既に存在する場合（コードレビューから）：

   - ファイル名を`{id}-pending-{priority}-{desc}.md` → `{id}-ready-{priority}-{desc}.md`に変更
   - YAMLフロントマターを更新：`status: pending` → `status: ready`
   - issue_id、priority、descriptionは変更しない

   新しいTodoを作成する場合：

   ```
   {next_id}-ready-{priority}-{brief-description}.md
   ```

   優先度マッピング：

   - 🔴 P1 (クリティカル) → `p1`
   - 🟡 P2 (重要) → `p2`
   - 🔵 P3 (あれば良い) → `p3`

   例：`042-ready-p1-transaction-boundaries.md`

2. **YAMLフロントマターを更新：**

   ```yaml
   ---
   status: ready # 重要: "pending"から"ready"に変更
   priority: p1 # または重大度に基づいてp2、p3
   issue_id: "042"
   tags: [category, relevant-tags]
   dependencies: []
   ---
   ```

3. **ファイルを作成または更新：**

   ```yaml
   # [イシュータイトル]

   ## 問題の説明
   [発見事項からの説明]

   ## 発見事項
   - [主要な発見]
   - 場所: [file_path:line_number]
   - [シナリオの詳細]

   ## 提案されるソリューション

   ### オプション1: [主要なソリューション]
   - **長所**: [メリット]
   - **短所**: [デメリットがあれば]
   - **工数**: [小規模/中規模/大規模]
   - **リスク**: [低/中/高]

   ## 推奨アクション
   [トリアージ中に入力 - 具体的なアクションプラン]

   ## 技術詳細
   - **影響を受けるファイル**: [ファイルリスト]
   - **関連コンポーネント**: [影響を受けるコンポーネント]
   - **データベース変更**: [はい/いいえ - はいの場合は説明]

   ## リソース
   - 元の発見: [このイシューのソース]
   - 関連イシュー: [ある場合]

   ## 受け入れ基準
   - [ ] [具体的な成功基準]
   - [ ] テストパス
   - [ ] コードレビュー済み

   ## 作業ログ

   ### {date} - 作業承認
   **担当:** Claude Triage System
   **アクション:**
   - トリアージセッション中にイシューが承認された
   - ステータスがpending → readyに変更
   - 着手して作業する準備が完了

   **学び:**
   - [コンテキストとインサイト]

   ## 備考
   ソース: {date}のトリアージセッション
   ```

4. **承認を確認:** "✅ 承認: `{new_filename}` (イシュー #{issue_id}) - ステータス: **ready** → 作業準備完了"

**ユーザーが「next」と言った場合：**

- **Todoファイルを削除** - 関連性がないためtodos/ディレクトリから削除
- 次のアイテムにスキップ
- スキップしたアイテムをサマリー用に追跡

**ユーザーが「custom」と言った場合：**

- 何を修正するか（優先度、説明、詳細）を質問
- 情報を更新
- 修正版を提示
- 再度質問：yes/next/custom

### ステップ3: すべて処理されるまで続行

- すべてのアイテムを一つずつ処理
- 可視性のためにTodoWriteで追跡
- アイテム間で承認を待たない - 続行する

### ステップ4: 最終サマリー

すべてのアイテム処理後：

````markdown
## トリアージ完了

**合計アイテム:** [X] **承認されたTodo (ready):** [Y] **スキップ:** [Z]

### 承認されたTodo（作業準備完了）:

- `042-ready-p1-transaction-boundaries.md` - トランザクション境界の問題
- `043-ready-p2-cache-optimization.md` - キャッシュパフォーマンス改善 ...

### スキップされたアイテム（削除済み）:

- アイテム #5: [理由] - todos/から削除
- アイテム #12: [理由] - todos/から削除

### 行われた変更のサマリー:

トリアージ中に以下のステータス更新が発生：

- **Pending → Ready:** ファイル名とフロントマターが承認ステータスを反映するよう更新
- **削除済み:** スキップされた発見のTodoファイルがtodos/ディレクトリから削除
- 各承認ファイルのYAMLフロントマターに`status: ready`が設定

### 次のステップ:

1. 作業準備完了の承認済みTodoを表示：
   ```bash
   ls todos/*-ready-*.md
   ```
````

2. 承認されたアイテムの作業を開始：

   ```bash
   /resolve  # 複数の承認済みアイテムを効率的に作業
   ```

3. または個別アイテムを選んで作業

4. 作業に応じてTodoステータスを更新：
   - Ready → In Progress（作業中はローカルコンテキストで）
   - In Progress → Complete（ファイル名変更：ready → complete、フロントマター更新）

```

## 応答フォーマット例

```

---

イシュー #5: マルチステップ操作のトランザクション境界欠落

重大度: 🔴 P1 (クリティカル)

カテゴリ: データ整合性 / セキュリティ

説明: GoogleOauthCallbacksコンサーン内のgoogle_oauth2_connectedコールバックが、トランザクション保護なしで複数のデータベース操作を実行しています。途中でステップが失敗すると、データベースが不整合な状態になります。

場所: app/controllers/concerns/google_oauth_callbacks.rb:13-50

問題シナリオ:

1. User.updateが成功（メール変更）
2. Account.save!が失敗（バリデーションエラー）
3. 結果：ユーザーはメールが変更されたが、関連するAccountがない
4. 次回のログイン試行が完全に失敗

トランザクションなしの操作:

- ユーザー確認（13行目）
- ウェイトリスト削除（14行目）
- ユーザープロファイル更新（21-23行目）
- アカウント作成（28-37行目）
- アバター添付（39-45行目）
- ジャーニー作成（47行目）

提案されるソリューション: すべての操作をApplicationRecord.transaction do ... endブロックでラップ

推定工数: 小規模（30分）

---

これをTodoリストに追加しますか？

1. yes - Todoファイルを作成
2. next - このアイテムをスキップ
3. custom - 作成前に修正

```

## 重要な実装詳細

### トリアージ中のステータス遷移

**「yes」が選択された場合：**
1. ファイル名変更：`{id}-pending-{priority}-{desc}.md` → `{id}-ready-{priority}-{desc}.md`
2. YAMLフロントマター更新：`status: pending` → `status: ready`
3. トリアージ承認エントリで作業ログを更新
4. 確認："✅ 承認: `{filename}` (イシュー #{issue_id}) - ステータス: **ready**"

**「next」が選択された場合：**
1. todos/ディレクトリからTodoファイルを削除
2. 次のアイテムにスキップ
3. システムにファイルは残らない

### 進捗追跡

ヘッダーとしてTodoを提示するたびに含める：
- **進捗:** X/Y 完了（例："3/10 完了"）
- **推定残り時間:** 進捗速度に基づいて
- **ペース:** 発見ごとの時間を監視し、それに応じて推定を調整

例：
```

進捗: 3/10 完了 | 推定時間: 約2分残り

```

### トリアージ中にコードを書かない

- ✅ 発見事項を提示
- ✅ yes/next/custom の決定を行う
- ✅ Todoファイルを更新（名前変更、フロントマター、作業ログ）
- ❌ 修正を実装したりコードを書いたりしない
- ❌ 詳細な実装詳細を追加しない
- ❌ それは/resolveフェーズの仕事
```

完了したらこれらのオプションを提示

```markdown
次に何をしますか？

1. /resolve_todo_parallelを実行してTodoを解決
2. Todoをコミット
3. 何もしない、休憩
```
